<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ò–≥—Ä–∞ 3 –≤ —Ä—è–¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: manipulation;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            color: #fff;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 480px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 5px;
            text-shadow: 0 0 10px #ff00ff;
            background: linear-gradient(to right, #ff8a00, #da1b60);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .info-item {
            text-align: center;
            flex: 1;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 3px;
        }
        
        .info-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 8px #00ffff;
        }
        
        .level-bar {
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .level-progress {
            height: 100%;
            background: linear-gradient(to right, #00c9ff, #92fe9d);
            border-radius: 8px;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .level-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: progress-shine 2s infinite;
        }
        
        @keyframes progress-shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .game-board-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            max-width: 100%;
            width: 100%;
            aspect-ratio: 1/1;
        }
        
        .cell {
            position: relative;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            background: rgba(50, 50, 50, 0.3);
            transition: transform 0.2s;
        }
        
        .cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
        }
        
        .cell:hover, .cell:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .candy {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: all 0.3s ease;
            z-index: 2;
            position: absolute;
            transition: transform 0.5s ease;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            flex: 1;
            max-width: 150px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #141e30, #243b55);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            width: 100%;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.5);
        }
        
        .modal h2 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .modal p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #ccc;
            line-height: 1.5;
        }
        
        .hidden {
            display: none;
        }
        
        .match-animation {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            animation: match-pulse 0.5s ease-out;
            z-index: 10;
        }
        
        @keyframes match-pulse {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .fall-animation {
            animation: fall 0.5s ease-in;
        }
        
        @keyframes fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(0); }
        }
        
        .level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: #00ffcc;
            text-shadow: 0 0 15px #00ffcc;
            animation: level-up 1.5s ease-out;
            opacity: 0;
            z-index: 100;
            pointer-events: none;
            text-align: center;
            width: 100%;
        }
        
        @keyframes level-up {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        
        .best-score {
            text-align: center;
            margin-top: 15px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .best-score-value {
            color: gold;
            font-weight: bold;
            text-shadow: 0 0 8px gold;
        }
        
        .footer {
            text-align: center;
            margin-top: 15px;
            color: #aaa;
            font-size: 0.8rem;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π */
        .ice-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(173, 216, 230, 0.8) 0%, rgba(173, 216, 230, 0.3) 70%);
            border-radius: 8px;
            z-index: 5;
            box-shadow: inset 0 0 10px rgba(0, 0, 255, 0.5);
            border: 2px solid rgba(100, 200, 255, 0.8);
        }
        
        .stone {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #444, #222);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
            border: 2px solid #333;
        }
        
        .stone-inner {
            width: 60%;
            height: 60%;
            background: linear-gradient(45deg, #666, #444);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .tutorial {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        .tutorial h3 {
            color: #00ffff;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .tutorial p {
            margin-bottom: 10px;
            color: #ccc;
        }
        
        .obstacle-example {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }
        
        .obstacle-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .obstacle-demo {
            width: 50px;
            height: 50px;
            position: relative;
            margin-bottom: 8px;
            border-radius: 8px;
            background: rgba(100, 100, 100, 0.3);
        }
        
        .obstacle-label {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .selected {
            box-shadow: 0 0 0 3px #00ffcc, inset 0 0 10px rgba(0, 255, 204, 0.8);
            z-index: 3;
        }
        
        .falling {
            z-index: 20;
            transition: transform 0.5s cubic-bezier(0.5, 0, 0.5, 1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–¢–†–ò –í –†–Ø–î</h1>
        </header>
        
        <div class="game-info">
            <div class="info-item">
                <div class="info-label">–£–†–û–í–ï–ù–¨</div>
                <div class="info-value" id="level">1</div>
            </div>
            <div class="info-item">
                <div class="info-label">–û–ß–ö–ò</div>
                <div class="info-value" id="score">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">–¶–ï–õ–¨</div>
                <div class="info-value" id="target">1000</div>
            </div>
        </div>
        
        <div class="level-bar">
            <div class="level-progress" id="levelProgress"></div>
        </div>
        
        <div class="game-board-container">
            <div class="game-board" id="gameBoard"></div>
        </div>
        
        <div class="controls">
            <button id="newGameBtn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>
        
        <div class="best-score">
            –í–∞—à –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span class="best-score-value" id="bestScore">0</span>
        </div>
        
        <div class="footer">
            –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        </div>
    </div>
    
    <div class="modal hidden" id="levelCompleteModal">
        <div class="modal-content">
            <h2>–£—Ä–æ–≤–µ–Ω—å <span id="completedLevel">1</span> –ø—Ä–æ–π–¥–µ–Ω!</h2>
            <p>–í—ã –Ω–∞–±—Ä–∞–ª–∏ <span id="levelScore">0</span> –æ—á–∫–æ–≤</p>
            <button id="continueBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>
    
    <div class="modal hidden" id="tutorialModal">
        <div class="modal-content">
            <h2>–ù–æ–≤—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è!</h2>
            <div class="tutorial">
                <p>–ù–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –≤–∏–¥—ã –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π:</p>
                
                <div class="obstacle-example">
                    <div class="obstacle-item">
                        <div class="obstacle-demo">
                            <div class="ice-overlay"></div>
                        </div>
                        <div class="obstacle-label">–õ–µ–¥</div>
                    </div>
                    <div class="obstacle-item">
                        <div class="obstacle-demo">
                            <div class="stone">
                                <div class="stone-inner"></div>
                            </div>
                        </div>
                        <div class="obstacle-label">–ö–∞–º–µ–Ω—å</div>
                    </div>
                </div>
                
                <h3>–ö–∞–∫ –∏—Ö –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å:</h3>
                <p>‚ùÑÔ∏è <strong>–õ–µ–¥</strong> - —Ç—Ä–µ–±—É–µ—Ç –æ–¥–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ä—è–¥–æ–º, —á—Ç–æ–±—ã —Ä–∞—Å—Ç–∞—è—Ç—å</p>
                <p>ü™® <strong>–ö–∞–º–µ–Ω—å</strong> - —Ç—Ä–µ–±—É–µ—Ç –¥–≤—É—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π —Ä—è–¥–æ–º, —á—Ç–æ–±—ã —Ä–∞–∑—Ä—É—à–∏—Ç—å—Å—è</p>
                <p>–° –∫–∞–∂–¥—ã–º —É—Ä–æ–≤–Ω–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π –±—É–¥–µ—Ç –±–æ–ª—å—à–µ!</p>
            </div>
            <button id="tutorialBtn">–ü–æ–Ω—è—Ç–Ω–æ!</button>
        </div>
    </div>
    
    <div class="level-up hidden" id="levelUp">–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù!</div>

    <script>
        // –ò–≥—Ä–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const BOARD_SIZE = 8;
        const CANDY_TYPES = 6;
        const LEVEL_TARGET_MULTIPLIER = 1.5;
        const OBSTACLES = {
            ICE: 100,
            STONE: 101
        };
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            board: [],
            score: 0,
            level: 1,
            target: 0,
            selectedCandy: null,
            isSwapping: false,
            isProcessing: false,
            bestScore: 0,
            touchStartX: 0,
            touchStartY: 0,
            touchStartTime: 0,
            obstacles: [],
            tutorialShown: false,
            fallFrom: {} // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø–∞–¥–∞—é—â–∏—Ö –∫–æ–Ω—Ñ–µ—Ç
        };
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const gameBoard = document.getElementById('gameBoard');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const targetElement = document.getElementById('target');
        const levelProgress = document.getElementById('levelProgress');
        const levelCompleteModal = document.getElementById('levelCompleteModal');
        const completedLevelElement = document.getElementById('completedLevel');
        const levelScoreElement = document.getElementById('levelScore');
        const continueBtn = document.getElementById('continueBtn');
        const newGameBtn = document.getElementById('newGameBtn');
        const levelUpElement = document.getElementById('levelUp');
        const bestScoreElement = document.getElementById('bestScore');
        const tutorialModal = document.getElementById('tutorialModal');
        const tutorialBtn = document.getElementById('tutorialBtn');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            loadGameState();
            startGame();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            continueBtn.addEventListener('click', () => {
                levelCompleteModal.classList.add('hidden');
                goToNextLevel();
            });
            
            tutorialBtn.addEventListener('click', () => {
                tutorialModal.classList.add('hidden');
                gameState.tutorialShown = true;
                saveGameState();
            });
            
            newGameBtn.addEventListener('click', () => {
                if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
                    resetGame();
                    startGame();
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤
            gameBoard.addEventListener('touchstart', handleTouchStart, { passive: false });
            gameBoard.addEventListener('touchend', handleTouchEnd, { passive: false });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –∫–∞—Å–∞–Ω–∏—è
        function handleTouchStart(e) {
            if (gameState.isProcessing) return;
            
            const touch = e.touches[0];
            gameState.touchStartX = touch.clientX;
            gameState.touchStartY = touch.clientY;
            gameState.touchStartTime = Date.now();
            
            const cell = touch.target.closest('.cell');
            if (cell) {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                
                // –í—ã–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—É
                if (!gameState.selectedCandy) {
                    selectCandy(row, col);
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è
        function handleTouchEnd(e) {
            if (gameState.isProcessing || !gameState.selectedCandy) return;
            
            const touch = e.changedTouches[0];
            const endX = touch.clientX;
            const endY = touch.clientY;
            const endTime = Date.now();
            
            const dx = endX - gameState.touchStartX;
            const dy = endY - gameState.touchStartY;
            const dt = endTime - gameState.touchStartTime;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞
            if (dt > 500 || (Math.abs(dx) < 20 && Math.abs(dy) < 20)) return;
            
            const [startRow, startCol] = gameState.selectedCandy;
            let targetRow = startRow;
            let targetCol = startCol;
            
            if (Math.abs(dx) > Math.abs(dy)) {
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø
                if (dx > 30) targetCol++; // –í–ø—Ä–∞–≤–æ
                else if (dx < -30) targetCol--; // –í–ª–µ–≤–æ
            } else {
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø
                if (dy > 30) targetRow++; // –í–Ω–∏–∑
                else if (dy < -30) targetRow--; // –í–≤–µ—Ä—Ö
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–ª–µ–≤–∞—è —è—á–µ–π–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ—Å–∫–∏
            if (targetRow >= 0 && targetRow < BOARD_SIZE && targetCol >= 0 && targetCol < BOARD_SIZE) {
                selectCandy(targetRow, targetCol);
            }
            
            e.preventDefault();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –∏–∑ localStorage
        function loadGameState() {
            const savedGame = localStorage.getItem('match3Game');
            if (savedGame) {
                try {
                    const parsedGame = JSON.parse(savedGame);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏–≥—Ä–∞ –∏–º–µ–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
                    if (parsedGame.board && parsedGame.score !== undefined && 
                        parsedGame.level !== undefined) {
                        gameState = parsedGame;
                        
                        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ obstacles - –º–∞—Å—Å–∏–≤
                        if (!Array.isArray(gameState.obstacles)) {
                            gameState.obstacles = [];
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        if (gameState.score > gameState.bestScore) {
                            gameState.bestScore = gameState.score;
                        }
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:', e);
                    resetGame();
                }
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –≤ localStorage
        function saveGameState() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (gameState.score > gameState.bestScore) {
                gameState.bestScore = gameState.score;
                bestScoreElement.textContent = gameState.bestScore;
            }
            
            localStorage.setItem('match3Game', JSON.stringify(gameState));
        }
        
        // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
        function startGame() {
            // –ï—Å–ª–∏ –∏–≥—Ä–∞ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            if (gameState.level === 0 || gameState.board.length === 0) {
                resetGame();
            }
            
            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ obstacles - –º–∞—Å—Å–∏–≤
            if (!Array.isArray(gameState.obstacles)) {
                gameState.obstacles = [];
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ 2, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏
            if (gameState.level >= 2 && !gameState.tutorialShown && gameState.level < 3) {
                tutorialModal.classList.remove('hidden');
            }
            
            updateUI();
            renderBoard();
        }
        
        // –°–±—Ä–æ—Å –∏–≥—Ä—ã
        function resetGame() {
            gameState.level = 1;
            gameState.score = 0;
            gameState.target = Math.floor(1000 * Math.pow(LEVEL_TARGET_MULTIPLIER, gameState.level - 1));
            gameState.selectedCandy = null;
            gameState.isSwapping = false;
            gameState.isProcessing = false;
            gameState.obstacles = [];
            gameState.tutorialShown = false;
            gameState.fallFrom = {};
            
            generateBoard();
            updateUI();
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        function generateBoard() {
            let validBoard = false;
            let attempts = 0;
            const maxAttempts = 50;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å—Å–∏–≤–∞
            gameState.board = [];
            for (let i = 0; i < BOARD_SIZE; i++) {
                gameState.board[i] = new Array(BOARD_SIZE).fill(0);
            }
            
            while (!validBoard && attempts < maxAttempts) {
                attempts++;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –∫–æ–Ω—Ñ–µ—Ç–∞–º–∏
                for (let row = 0; row < BOARD_SIZE; row++) {
                    for (let col = 0; col < BOARD_SIZE; col++) {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —è—á–µ–π–∫–∏ —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
                        if (gameState.board[row][col] > 0) continue;
                        
                        let candyType;
                        let validCandy = false;
                        let candyAttempts = 0;
                        const maxCandyAttempts = 10;
                        
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–µ—Ç—É, –∏–∑–±–µ–≥–∞—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                        do {
                            candyType = Math.floor(Math.random() * CANDY_TYPES) + 1;
                            candyAttempts++;
                            
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                            let hasVerticalMatch = false;
                            if (row >= 2) {
                                hasVerticalMatch = (
                                    gameState.board[row-1][col] === candyType && 
                                    gameState.board[row-2][col] === candyType
                                );
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                            let hasHorizontalMatch = false;
                            if (col >= 2) {
                                hasHorizontalMatch = (
                                    gameState.board[row][col-1] === candyType && 
                                    gameState.board[row][col-2] === candyType
                                );
                            }
                            
                            validCandy = !hasVerticalMatch && !hasHorizontalMatch;
                            
                        } while (!validCandy && candyAttempts < maxCandyAttempts);
                        
                        gameState.board[row][col] = candyType;
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è
                addObstacles();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ–¥–æ–≤
                validBoard = hasMoves();
            }
            
            if (!validBoard) {
                console.log("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–∞–ª–∏–¥–Ω–æ–µ –ø–æ–ª–µ –ø–æ—Å–ª–µ " + maxAttempts + " –ø–æ–ø—ã—Ç–æ–∫. –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º...");
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –ø–æ–ª–µ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
                generateSimpleBoard();
            }
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–ª—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        function generateSimpleBoard() {
            for (let row = 0; row < BOARD_SIZE; row++) {
                gameState.board[row] = [];
                for (let col = 0; col < BOARD_SIZE; col++) {
                    gameState.board[row][col] = Math.floor(Math.random() * CANDY_TYPES) + 1;
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            addObstacles();
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
        function addObstacles() {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            gameState.obstacles = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è
            if (gameState.level >= 2) {
                // –õ–µ–¥
                const iceCount = Math.min(2 + gameState.level, 8);
                for (let i = 0; i < iceCount; i++) {
                    const row = Math.floor(Math.random() * BOARD_SIZE);
                    const col = Math.floor(Math.random() * BOARD_SIZE);
                    
                    // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —É–∂–µ –∑–∞–Ω—è—Ç—ã–µ –∫–ª–µ—Ç–∫–∏
                    if (!getObstacleAt(row, col)) {
                        gameState.obstacles.push({type: OBSTACLES.ICE, row, col});
                    }
                }
            }
            
            if (gameState.level >= 3) {
                // –ö–∞–º–Ω–∏
                const stoneCount = Math.min(1 + Math.floor(gameState.level / 2), 5);
                for (let i = 0; i < stoneCount; i++) {
                    const row = Math.floor(Math.random() * BOARD_SIZE);
                    const col = Math.floor(Math.random() * BOARD_SIZE);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞
                    if (!getObstacleAt(row, col)) {
                        gameState.obstacles.push({type: OBSTACLES.STONE, row, col});
                    }
                }
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –≤ —è—á–µ–π–∫–µ
        function getObstacleAt(row, col) {
            if (!gameState.obstacles) return null;
            return gameState.obstacles.find(obs => obs.row === row && obs.col === col) || null;
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        function removeObstacle(row, col) {
            if (!gameState.obstacles) return false;
            const index = gameState.obstacles.findIndex(obs => obs.row === row && obs.col === col);
            if (index !== -1) {
                gameState.obstacles.splice(index, 1);
                return true;
            }
            return false;
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
        function renderBoard() {
            gameBoard.innerHTML = '';
            
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–µ—Ç—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (gameState.board[row][col] > 0) {
                        const candy = document.createElement('img');
                        candy.className = 'candy';
                        candy.src = `candy${gameState.board[row][col]}.png`;
                        candy.alt = `–ö–æ–Ω—Ñ–µ—Ç–∞ ${gameState.board[row][col]}`;
                        cell.appendChild(candy);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
                    const obstacle = getObstacleAt(row, col);
                    if (obstacle) {
                        if (obstacle.type === OBSTACLES.ICE) {
                            const iceOverlay = document.createElement('div');
                            iceOverlay.className = 'ice-overlay';
                            cell.appendChild(iceOverlay);
                        } else if (obstacle.type === OBSTACLES.STONE) {
                            const stone = document.createElement('div');
                            stone.className = 'stone';
                            const stoneInner = document.createElement('div');
                            stoneInner.className = 'stone-inner';
                            stone.appendChild(stoneInner);
                            cell.appendChild(stone);
                        }
                    }
                    
                    cell.addEventListener('click', () => selectCandy(row, col));
                    gameBoard.appendChild(cell);
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —è—á–µ–π–∫–∏
        function updateCell(row, col) {
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (!cell) return;
            
            cell.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–µ—Ç—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (gameState.board[row][col] > 0) {
                const candy = document.createElement('img');
                candy.className = 'candy';
                candy.src = `candy${gameState.board[row][col]}.png`;
                candy.alt = `–ö–æ–Ω—Ñ–µ—Ç–∞ ${gameState.board[row][col]}`;
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è
                if (gameState.fallFrom[`${row},${col}`]) {
                    const [fromRow] = gameState.fallFrom[`${row},${col}`];
                    const distance = row - fromRow;
                    candy.style.transform = `translateY(${-distance * 100}%)`;
                    candy.classList.add('falling');
                    
                    setTimeout(() => {
                        candy.style.transform = 'translateY(0)';
                        setTimeout(() => {
                            candy.classList.remove('falling');
                        }, 500);
                    }, 10);
                }
                
                cell.appendChild(candy);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            const obstacle = getObstacleAt(row, col);
            if (obstacle) {
                if (obstacle.type === OBSTACLES.ICE) {
                    const iceOverlay = document.createElement('div');
                    iceOverlay.className = 'ice-overlay';
                    cell.appendChild(iceOverlay);
                } else if (obstacle.type === OBSTACLES.STONE) {
                    const stone = document.createElement('div');
                    stone.className = 'stone';
                    const stoneInner = document.createElement('div');
                    stoneInner.className = 'stone-inner';
                    stone.appendChild(stoneInner);
                    cell.appendChild(stone);
                }
            }
        }
        
        // –í—ã–±–æ—Ä –∫–æ–Ω—Ñ–µ—Ç—ã
        function selectCandy(row, col) {
            if (gameState.isProcessing) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —è—á–µ–π–∫–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ
            const obstacle = getObstacleAt(row, col);
            if (obstacle && obstacle.type === OBSTACLES.STONE) return;
            
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            
            // –ï—Å–ª–∏ –∫–æ–Ω—Ñ–µ—Ç–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞
            if (gameState.selectedCandy) {
                const [prevRow, prevCol] = gameState.selectedCandy;
                const prevCell = document.querySelector(`.cell[data-row="${prevRow}"][data-col="${prevCol}"]`);
                
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Ç–∞ –∂–µ —Å–∞–º–∞—è –∫–æ–Ω—Ñ–µ—Ç–∞ - —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                if (prevRow === row && prevCol === col) {
                    prevCell.classList.remove('selected');
                    gameState.selectedCandy = null;
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è—é—Ç—Å—è –ª–∏ –∫–æ–Ω—Ñ–µ—Ç—ã —Å–æ—Å–µ–¥—è–º–∏
                const isNeighbor = 
                    (Math.abs(prevRow - row) === 1 && prevCol === col) || 
                    (Math.abs(prevCol - col) === 1 && prevRow === row);
                
                if (isNeighbor) {
                    gameState.isSwapping = true;
                    
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–Ω—Ñ–µ—Ç—ã
                    prevCell.classList.remove('selected');
                    
                    // –ú–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–µ—Ç—ã –º–µ—Å—Ç–∞–º–∏
                    swapCandies(prevRow, prevCol, row, col, () => {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±—Ä–∞–∑–æ–≤–∞–ª–∏—Å—å –ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                        const matches = findMatches();
                        
                        if (matches.length > 0) {
                            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö
                            processMatches(matches);
                        } else {
                            // –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ
                            swapCandies(prevRow, prevCol, row, col, () => {
                                gameState.isSwapping = false;
                                gameState.selectedCandy = null;
                            });
                        }
                    });
                } else {
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–Ω—Ñ–µ—Ç—ã
                    prevCell.classList.remove('selected');
                    // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–µ—Ç—É
                    cell.classList.add('selected');
                    gameState.selectedCandy = [row, col];
                }
            } else {
                // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–µ—Ç—É
                cell.classList.add('selected');
                gameState.selectedCandy = [row, col];
            }
        }
        
        // –û–±–º–µ–Ω –∫–æ–Ω—Ñ–µ—Ç –º–µ—Å—Ç–∞–º–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        function swapCandies(row1, col1, row2, col2, callback) {
            // –ú–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–µ—Ç—ã –≤ –º–∞—Å—Å–∏–≤–µ
            const temp = gameState.board[row1][col1];
            gameState.board[row1][col1] = gameState.board[row2][col2];
            gameState.board[row2][col2] = temp;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateCell(row1, col1);
            updateCell(row2, col2);
            
            // –í—ã–∑—ã–≤–∞–µ–º callback –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(callback, 300);
        }
        
        // –ü–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        function findMatches() {
            const matches = [];
            const visited = new Set();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE - 2; col++) {
                    const candyType = gameState.board[row][col];
                    if (candyType === 0) continue; // –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞
                    
                    if (candyType === gameState.board[row][col+1] && 
                        candyType === gameState.board[row][col+2]) {
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—Ö–æ–¥–∏—Ç –ª–∏ —É–∂–µ —ç—Ç–∞ —è—á–µ–π–∫–∞ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                        if (visited.has(`${row},${col}`)) continue;
                        
                        const match = [[row, col], [row, col+1], [row, col+2]];
                        visited.add(`${row},${col}`);
                        visited.add(`${row},${col+1}`);
                        visited.add(`${row},${col+2}`);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–ª–∏–Ω–Ω–µ–µ 3
                        let nextCol = col + 3;
                        while (nextCol < BOARD_SIZE && gameState.board[row][nextCol] === candyType) {
                            match.push([row, nextCol]);
                            visited.add(`${row},${nextCol}`);
                            nextCol++;
                        }
                        
                        matches.push(match);
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            for (let row = 0; row < BOARD_SIZE - 2; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    const candyType = gameState.board[row][col];
                    if (candyType === 0) continue; // –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞
                    
                    if (candyType === gameState.board[row+1][col] && 
                        candyType === gameState.board[row+2][col]) {
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—Ö–æ–¥–∏—Ç –ª–∏ —É–∂–µ —ç—Ç–∞ —è—á–µ–π–∫–∞ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                        if (visited.has(`${row},${col}`)) continue;
                        
                        const match = [[row, col], [row+1, col], [row+2, col]];
                        visited.add(`${row},${col}`);
                        visited.add(`${row+1},${col}`);
                        visited.add(`${row+2},${col}`);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–ª–∏–Ω–Ω–µ–µ 3
                        let nextRow = row + 3;
                        while (nextRow < BOARD_SIZE && gameState.board[nextRow][col] === candyType) {
                            match.push([nextRow, col]);
                            visited.add(`${nextRow},${col}`);
                            nextRow++;
                        }
                        
                        matches.push(match);
                    }
                }
            }
            
            return matches;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
        function processMatches(matches) {
            if (matches.length === 0) {
                gameState.isSwapping = false;
                gameState.selectedCandy = null;
                return;
            }
            
            gameState.isProcessing = true;
            
            // –£–¥–∞–ª—è–µ–º —Å–æ–≤–ø–∞–≤—à–∏–µ –∫–æ–Ω—Ñ–µ—Ç—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—á–∫–∏
            let totalScore = 0;
            const matchedCells = [];
            
            matches.forEach(match => {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—á–∫–∏ –∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                const matchScore = 10 * match.length * gameState.level;
                totalScore += matchScore;
                
                // –ü–æ–º–µ—á–∞–µ–º —Å–æ–≤–ø–∞–≤—à–∏–µ –∫–æ–Ω—Ñ–µ—Ç—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                match.forEach(([row, col]) => {
                    if (!matchedCells.some(cell => cell[0] === row && cell[1] === col)) {
                        matchedCells.push([row, col]);
                        
                        // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–µ—Ç—ã
                        const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                        if (cell) {
                            const animation = document.createElement('div');
                            animation.className = 'match-animation';
                            cell.appendChild(animation);
                            
                            setTimeout(() => {
                                animation.remove();
                            }, 500);
                        }
                    }
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π —Ä—è–¥–æ–º —Å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏
            const affectedObstacles = new Set();
            
            matches.forEach(match => {
                match.forEach(([row, col]) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å–µ–¥–Ω–∏–µ –∫–ª–µ—Ç–∫–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
                    const neighbors = [
                        [row-1, col], [row+1, col], [row, col-1], [row, col+1]
                    ];
                    
                    neighbors.forEach(([nRow, nCol]) => {
                        if (nRow >= 0 && nRow < BOARD_SIZE && nCol >= 0 && nCol < BOARD_SIZE) {
                            const obstacle = getObstacleAt(nRow, nCol);
                            if (obstacle) {
                                affectedObstacles.add(`${nRow},${nCol}`);
                                
                                // –î–ª—è –∫–∞–º–Ω—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–≤–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ä—è–¥–æ–º
                                if (obstacle.type === OBSTACLES.STONE) {
                                    obstacle.hits = (obstacle.hits || 0) + 1;
                                    if (obstacle.hits >= 2) {
                                        removeObstacle(nRow, nCol);
                                    }
                                } else if (obstacle.type === OBSTACLES.ICE) {
                                    // –õ–µ–¥ —Ä–∞–∑—Ä—É—à–∞–µ—Ç—Å—è –æ—Ç –æ–¥–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ä—è–¥–æ–º
                                    removeObstacle(nRow, nCol);
                                }
                            }
                        }
                    });
                });
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
            gameState.score += totalScore;
            updateUI();
            
            // –£–¥–∞–ª—è–µ–º —Å–æ–≤–ø–∞–≤—à–∏–µ –∫–æ–Ω—Ñ–µ—Ç—ã
            setTimeout(() => {
                matchedCells.forEach(([row, col]) => {
                    gameState.board[row][col] = 0;
                    updateCell(row, col);
                });
                
                // –°–¥–≤–∏–≥–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—ã –≤–Ω–∏–∑
                dropCandies();
            }, 500);
        }
        
        // –°–¥–≤–∏–≥ –∫–æ–Ω—Ñ–µ—Ç –≤–Ω–∏–∑
        function dropCandies() {
            let moved = false;
            gameState.fallFrom = {};
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å—Ç–æ–ª–±—Ü–∞–º
            for (let col = 0; col < BOARD_SIZE; col++) {
                // –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω–∏–∂–Ω–µ–π —Å—Ç—Ä–æ–∫–∏
                let emptySpaces = 0;
                for (let row = BOARD_SIZE - 1; row >= 0; row--) {
                    // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ –ø—É—Å—Ç–∞ –∏ –Ω–µ—Ç –∫–∞–º–Ω—è
                    if (gameState.board[row][col] === 0 && !getObstacleAt(row, col)) {
                        emptySpaces++;
                    } else if (emptySpaces > 0) {
                        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—É –≤–Ω–∏–∑
                        const newRow = row + emptySpaces;
                        gameState.board[newRow][col] = gameState.board[row][col];
                        gameState.board[row][col] = 0;
                        
                        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                        gameState.fallFrom[`${newRow},${col}`] = [row, col];
                        moved = true;
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤–µ—Ä—Ö–Ω–∏–µ –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –Ω–æ–≤—ã–º–∏ –∫–æ–Ω—Ñ–µ—Ç–∞–º–∏
                for (let row = 0; row < emptySpaces; row++) {
                    if (!getObstacleAt(row, col)) {
                        gameState.board[row][col] = Math.floor(Math.random() * CANDY_TYPES) + 1;
                        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –∫–æ–Ω—Ñ–µ—Ç–∞ –ø–∞–¥–∞–µ—Ç —Å–≤–µ—Ä—Ö—É
                        gameState.fallFrom[`${row},${col}`] = [row - emptySpaces, col];
                        moved = true;
                    }
                }
            }
            
            if (moved) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                for (let row = 0; row < BOARD_SIZE; row++) {
                    for (let col = 0; col < BOARD_SIZE; col++) {
                        updateCell(row, col);
                    }
                }
                
                setTimeout(() => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                    const newMatches = findMatches();
                    
                    if (newMatches.length > 0) {
                        processMatches(newMatches);
                    } else {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ –ª–∏ —Ü–µ–ª—å —É—Ä–æ–≤–Ω—è
                        if (gameState.score >= gameState.target) {
                            showLevelCompleteModal();
                        } else {
                            gameState.isProcessing = false;
                            gameState.isSwapping = false;
                            gameState.selectedCandy = null;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ —Ö–æ–¥—ã
                            if (!hasMoves()) {
                                // –ï—Å–ª–∏ —Ö–æ–¥–æ–≤ –Ω–µ—Ç - –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–ª–µ
                                setTimeout(() => {
                                    generateBoard();
                                    renderBoard();
                                    gameState.isProcessing = false;
                                }, 500);
                            }
                        }
                    }
                }, 500);
            } else {
                gameState.isProcessing = false;
                gameState.isSwapping = false;
                gameState.selectedCandy = null;
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
        function showLevelCompleteModal() {
            completedLevelElement.textContent = gameState.level;
            levelScoreElement.textContent = gameState.score;
            levelCompleteModal.classList.remove('hidden');
        }
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
        function goToNextLevel() {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
            gameState.level++;
            gameState.target = Math.floor(1000 * Math.pow(LEVEL_TARGET_MULTIPLIER, gameState.level - 1));
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            saveGameState();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ
            generateBoard();
            renderBoard();
            
            gameState.isProcessing = false;
            gameState.isSwapping = false;
            gameState.selectedCandy = null;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ 2, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏
            if (gameState.level === 2 && !gameState.tutorialShown) {
                tutorialModal.classList.remove('hidden');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            scoreElement.textContent = gameState.score;
            levelElement.textContent = gameState.level;
            targetElement.textContent = gameState.target;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è
            const progressPercent = Math.min(100, (gameState.score / gameState.target) * 100);
            levelProgress.style.width = `${progressPercent}%`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (gameState.score > gameState.bestScore) {
                gameState.bestScore = gameState.score;
            }
            bestScoreElement.textContent = gameState.bestScore;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            saveGameState();
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
        function hasMoves() {
            // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–ø–∏—è –¥–æ—Å–∫–∏
            const tempBoard = JSON.parse(JSON.stringify(gameState.board));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ–±–º–µ–Ω—ã
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    // –ü—Ä–æ–±—É–µ–º –æ–±–º–µ–Ω –≤–ø—Ä–∞–≤–æ
                    if (col < BOARD_SIZE - 1) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
                        if (getObstacleAt(row, col) || getObstacleAt(row, col+1)) continue;
                        
                        // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
                        [tempBoard[row][col], tempBoard[row][col+1]] = [tempBoard[row][col+1], tempBoard[row][col]];
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                        if (checkMatchesForBoard(tempBoard).length > 0) {
                            return true;
                        }
                        
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                        [tempBoard[row][col], tempBoard[row][col+1]] = [tempBoard[row][col+1], tempBoard[row][col]];
                    }
                    
                    // –ü—Ä–æ–±—É–µ–º –æ–±–º–µ–Ω –≤–Ω–∏–∑
                    if (row < BOARD_SIZE - 1) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
                        if (getObstacleAt(row, col) || getObstacleAt(row+1, col)) continue;
                        
                        // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
                        [tempBoard[row][col], tempBoard[row+1][col]] = [tempBoard[row+1][col], tempBoard[row][col]];
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                        if (checkMatchesForBoard(tempBoard).length > 0) {
                            return true;
                        }
                        
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                        [tempBoard[row][col], tempBoard[row+1][col]] = [tempBoard[row+1][col], tempBoard[row][col]];
                    }
                }
            }
            
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–π –¥–æ—Å–∫–∏
        function checkMatchesForBoard(board) {
            const matches = [];
            const visited = new Set();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE - 2; col++) {
                    const candyType = board[row][col];
                    if (candyType === 0) continue; // –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞
                    
                    if (candyType === board[row][col+1] && 
                        candyType === board[row][col+2]) {
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—Ö–æ–¥–∏—Ç –ª–∏ —É–∂–µ —ç—Ç–∞ —è—á–µ–π–∫–∞ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                        if (visited.has(`${row},${col}`)) continue;
                        
                        const match = [[row, col], [row, col+1], [row, col+2]];
                        visited.add(`${row},${col}`);
                        visited.add(`${row},${col+1}`);
                        visited.add(`${row},${col+2}`);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–ª–∏–Ω–Ω–µ–µ 3
                        let nextCol = col + 3;
                        while (nextCol < BOARD_SIZE && board[row][nextCol] === candyType) {
                            match.push([row, nextCol]);
                            visited.add(`${row},${nextCol}`);
                            nextCol++;
                        }
                        
                        matches.push(match);
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            for (let row = 0; row < BOARD_SIZE - 2; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    const candyType = board[row][col];
                    if (candyType === 0) continue; // –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞
                    
                    if (candyType === board[row+1][col] && 
                        candyType === board[row+2][col]) {
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—Ö–æ–¥–∏—Ç –ª–∏ —É–∂–µ —ç—Ç–∞ —è—á–µ–π–∫–∞ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                        if (visited.has(`${row},${col}`)) continue;
                        
                        const match = [[row, col], [row+1, col], [row+2, col]];
                        visited.add(`${row},${col}`);
                        visited.add(`${row+1},${col}`);
                        visited.add(`${row+2},${col}`);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–ª–∏–Ω–Ω–µ–µ 3
                        let nextRow = row + 3;
                        while (nextRow < BOARD_SIZE && board[nextRow][col] === candyType) {
                            match.push([nextRow, col]);
                            visited.add(`${nextRow},${col}`);
                            nextRow++;
                        }
                        
                        matches.push(match);
                    }
                }
            }
            
            return matches;
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>